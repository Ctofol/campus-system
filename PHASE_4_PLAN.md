# 灵析运动 (Lingxi Sports) 第四阶段优化方案与可行性分析

**文档日期**：2026-02-06
**状态**：待确认 (Pending Approval)

---

## 1. 核心优化方向与执行方案

### 1.1 首页动态化与“今日待办”重构
**当前问题**：
- 教师端“今日待办”为静态写死数据，无法反映真实业务。
- 学生端/教师端首页部分图表（如体能概览）未对接真实数据。

**执行方案**：
- **后端 (Python/FastAPI)**：
  - 改造 `/teacher/stats` 接口，聚合“待审批数量”（请假/申诉）与“临期任务”（距离截止<24h）。
  - 新增 `/teacher/dashboard/todos` 专用接口，返回结构化的待办列表。
- **前端 (Uni-app)**：
  - 移除 `home.vue` 中的 Mock 数据 HTML。
  - 封装通用请求逻辑，在 `onShow` 时并发获取各项数据。

### 1.2 TabBar 性能重构（大手术）
**当前问题**：
- 使用自定义组件 + `redirectTo` 跳转，导致每次切换 Tab 页面都会销毁重建，造成真机卡顿、闪屏，无页面缓存。

**执行方案**：
- **架构升级**：采用 **Wrapper Page (容器页) + Component (组件化)** 模式。
  - 创建 4 个原生 Tab 页：`pages/tab/home`, `pages/tab/run`, `pages/tab/stats`, `pages/tab/mine`。
  - 在 `pages.json` 配置原生 `tabBar`，确保底层页面常驻内存（Keep-alive）。
- **动态适配**：
  - 在容器页内部通过 `v-if="role"` 动态渲染 `StudentHome` 或 `TeacherHome` 组件。
  - 使用 `uni.setTabBarItem` 或自定义覆盖层（Native Custom TabBar）来微调教师端（隐藏多余的 Tab 或置灰），**保证视觉样式与当前完全一致**。

### 1.3 注册逻辑优化
**当前问题**：
- 注册流程繁琐，包含“公安院校”等非通用字段。
- 缺乏有效的验证码机制。

**执行方案**：
- **精简表单**：保留 `学校ID`、`班级ID`（用于归属管理），移除 `是否公安院校`、`警号` 等特定业务字段。
- **验证码优化 (Graphical CAPTCHA)**：
  - **图形验证码**：后端生成 4 位随机字符图片（Base64），前端展示，用户输入。
  - **机制**：完全替代短信验证码，0 成本实现防刷注册。

---

## 2. 摄像头功能故障分析与解决 (Camera Troubleshooting) - **已解决 (Resolved)**

### 2.1 最终结论
经过多轮排查与真机调试，确认由于 **HBuilderX 自定义调试基座环境异常**（可能涉及缓存残留或版本不匹配），导致内嵌 `<camera>` 组件无法正常加载（表现为黑屏或 API 缺失）。

### 2.2 解决方案 (Current Implementation)
采用 **自动降级策略**，优先保证业务功能可用：
1.  **检测机制**：页面加载时尝试初始化 `<camera>` 上下文。如果失败或检测到环境异常，自动切换至 **系统接口模式**。
2.  **替代方案**：使用 `plus.camera` 接口直接调用手机系统自带相机。
    *   **拍照**：`cmr.captureImage()`
    *   **录像**：`cmr.startVideoCapture()`
3.  **业务闭环**：验证证实，通过系统相机录制的视频/图片可以正常返回路径，足以支持后续的“视频上传”、“AI 分析”等业务逻辑。

### 2.3 状态更新
- [x] 摄像头最小 MVP 页面 (`camera-min.nvue`) 已改造为系统相机调用演示页。
- [x] 验证了视频录制与模拟 AI 分析流程。
- [ ] 后续如需内嵌预览体验，需等待开发环境（基座）彻底重置或打包正式版后再次验证。

---

## 3. 下一步行动建议 (Next Steps)

建议按照以下顺序推进开发（优先级从高到低）：

1.  **TabBar 架构重构**：这是地基，先把卡顿问题解决了，后续开发体验才好。
2.  **注册优化**：精简字段 + 接入图形验证码。
3.  **首页动态化**：实现“今日待办”接口与“体能概览”统计。
4.  **摄像头修复**：最后攻坚，按上述分析逐一排查。

**确认：**
是否同意按此文档开始执行？
