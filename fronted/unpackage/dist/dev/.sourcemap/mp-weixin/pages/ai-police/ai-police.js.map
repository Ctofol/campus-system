{"version":3,"file":"ai-police.js","sources":["pages/ai-police/ai-police.vue","E:/HBuilderX/HBuilderX.4.87.2025121004/HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvYWktcG9saWNlL2FpLXBvbGljZS52dWU"],"sourcesContent":["<template>\n  <view class=\"ai-police\">\n    <view class=\"camera-area\">\n      <!-- 实时摄像头画面 -->\n      <!-- #ifdef H5 -->\n      <view class=\"h5-camera-wrapper\">\n        <video id=\"h5-video-el\" class=\"real-camera\" autoplay playsinline muted :controls=\"false\"></video>\n        <view class=\"camera-overlay\">\n          <view class=\"camera-tip\" v-if=\"!isDetecting\">请将全身置于摄像头区域内</view>\n          <view v-else class=\"skeleton-overlay\">\n            <view class=\"skeleton-box\"></view>\n          </view>\n          <view class=\"debug-info\" v-if=\"isDetecting\">\n            置信度: {{ confidence }}% | 姿态: {{ posture }}\n          </view>\n        </view>\n      </view>\n      <!-- #endif -->\n      <!-- #ifndef H5 -->\n      <camera \n        class=\"real-camera\"\n        device-position=\"front\" \n        flash=\"off\" \n        @error=\"handleCameraError\"\n      >\n        <cover-view class=\"camera-overlay\">\n          <cover-view class=\"camera-tip\" v-if=\"!isDetecting\">请将全身置于摄像头区域内</cover-view>\n          <cover-view v-else class=\"skeleton-overlay\">\n            <!-- 简易骨架模拟 (使用cover-view) -->\n            <cover-view class=\"skeleton-box\"></cover-view>\n          </cover-view>\n          <cover-view class=\"debug-info\" v-if=\"isDetecting\">\n            置信度: {{ confidence }}% | 姿态: {{ posture }}\n          </cover-view>\n        </cover-view>\n      </camera>\n      <!-- #endif -->\n    </view>\n\n    <view class=\"dashboard\">\n      <view class=\"counter-box\">\n        <text class=\"count-label\">有效计数</text>\n        <text class=\"count-val\">{{ count }}</text>\n      </view>\n      <view class=\"status-box\">\n        <text class=\"status-label\">当前状态</text>\n        <text class=\"status-val\" :class=\"statusClass\">{{ statusText }}</text>\n      </view>\n    </view>\n\n    <view class=\"controls\">\n      <button v-if=\"!isDetecting\" class=\"btn-start\" @click=\"startDetect\">开始AI计数</button>\n      <button v-else class=\"btn-stop\" @click=\"stopDetect\">结束训练</button>\n      \n      <view class=\"simulation-tools\">\n        <text class=\"tool-title\">开发调试：模拟场景</text>\n        <view class=\"tool-btns\">\n          <button size=\"mini\" @click=\"simValidAction\">模拟有效动作</button>\n          <button size=\"mini\" @click=\"simCheat('遮挡')\">模拟遮挡</button>\n          <button size=\"mini\" @click=\"simCheat('多人')\">模拟多人</button>\n          <button size=\"mini\" @click=\"simCheat('非活体')\">模拟照片攻击</button>\n        </view>\n      </view>\n    </view>\n  </view>\n</template>\n\n<script setup>\nimport { ref, onMounted, onUnmounted } from 'vue';\n\nconst isDetecting = ref(false);\nconst count = ref(0);\nconst statusText = ref('准备就绪');\nconst statusClass = ref('normal');\nconst confidence = ref(0);\nconst posture = ref('Standing');\n\nlet timer = null;\n\n// #ifdef H5\nlet h5Stream = null;\n\nonMounted(() => {\n  initH5Camera();\n});\n\nonUnmounted(() => {\n  if (h5Stream) {\n    h5Stream.getTracks().forEach(track => track.stop());\n  }\n});\n\nconst initH5Camera = async () => {\n  try {\n    // 检查浏览器支持\n    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {\n      throw new Error('浏览器不支持摄像头访问');\n    }\n    \n    const stream = await navigator.mediaDevices.getUserMedia({ \n      video: { \n        facingMode: 'user',\n        width: { ideal: 640 },\n        height: { ideal: 480 }\n      } \n    });\n    \n    h5Stream = stream;\n    \n    // 延迟确保DOM渲染\n    setTimeout(() => {\n      let video = document.getElementById('h5-video-el');\n      console.log('AI Police Video Element:', video);\n      \n      // 兼容查找\n      if (video && video.tagName !== 'VIDEO') {\n        const inner = video.querySelector('video');\n        if (inner) video = inner;\n      }\n      \n      if (video && typeof video.play === 'function') {\n        video.srcObject = stream;\n        video.play().catch(e => console.error('Play error:', e));\n      } else {\n        console.error('Video element invalid:', video);\n        uni.showToast({ title: '画面加载失败', icon: 'none' });\n      }\n    }, 500);\n\n  } catch (e) {\n    handleCameraError(e);\n  }\n};\n// #endif\n\nconst startDetect = () => {\n  isDetecting.value = true;\n  statusText.value = '正在检测...';\n  statusClass.value = 'normal';\n  count.value = 0;\n  startSimulationLoop();\n};\n\nconst stopDetect = () => {\n  isDetecting.value = false;\n  statusText.value = '训练结束';\n  clearInterval(timer);\n  \n  uni.showModal({\n    title: '训练结束',\n    content: `本次训练共完成 ${count.value} 次，是否查看结果？`,\n    confirmText: '查看结果',\n    cancelText: '取消',\n    success: (res) => {\n      if (res.confirm) {\n        uni.showLoading({ title: '正在保存...' });\n        setTimeout(() => {\n            uni.hideLoading();\n            uni.navigateTo({\n              url: `/pages/result/result?mode=test&project=AI智能训练&count=${count.value}&duration=0`\n            });\n        }, 800);\n      }\n    }\n  });\n};\n\nconst startSimulationLoop = () => {\n  timer = setInterval(() => {\n    // 随机波动置信度\n    confidence.value = (95 + Math.random() * 5).toFixed(1);\n  }, 1000);\n};\n\nconst simValidAction = () => {\n  if (!isDetecting) return;\n  statusText.value = '动作标准';\n  statusClass.value = 'success';\n  posture.value = 'Squat Down';\n  setTimeout(() => {\n    count.value++;\n    posture.value = 'Standing';\n    statusText.value = '正在检测...';\n    statusClass.value = 'normal';\n  }, 800);\n};\n\nconst simCheat = (type) => {\n  if (!isDetecting) return;\n  statusText.value = `警告：${type}`;\n  statusClass.value = 'warn';\n  confidence.value = (Math.random() * 40).toFixed(1);\n  \n  uni.vibrateLong();\n  uni.showToast({\n    title: `检测到异常：${type}`,\n    icon: 'none',\n    duration: 2000\n  });\n\n  setTimeout(() => {\n    statusText.value = '正在检测...';\n    statusClass.value = 'normal';\n    confidence.value = 98.5;\n  }, 2000);\n};\n\nconst handleCameraError = (e) => {\n  console.error('Camera Error:', e);\n  let msg = '无法访问摄像头';\n  if (e.name === 'NotAllowedError' || e.message === 'Permission denied') {\n    msg = '权限被拒绝，请在设置中允许摄像头访问';\n  } else if (e.name === 'NotFoundError') {\n    msg = '未检测到摄像头设备';\n  } else if (e.name === 'NotSupportedError') {\n    msg = '浏览器不支持该摄像头配置';\n  }\n  \n  uni.showToast({\n    title: msg,\n    icon: 'none',\n    duration: 3000\n  });\n};\n</script>\n\n<style scoped>\n.ai-police {\n  min-height: 100vh;\n  background: #1a1a1a;\n  color: #fff;\n  display: flex;\n  flex-direction: column;\n}\n.camera-area {\n  height: 60vh;\n  background: #000;\n  position: relative;\n}\n/* #ifdef H5 */\n.h5-camera-wrapper {\n  width: 100%;\n  height: 100%;\n  position: relative;\n}\n/* #endif */\n.real-camera {\n  width: 100%;\n  height: 100%;\n}\n.camera-overlay {\n  width: 100%;\n  height: 100%;\n  display: flex;\n  flex-direction: column;\n  justify-content: center;\n  align-items: center;\n  position: absolute;\n  top: 0;\n  left: 0;\n  z-index: 10;\n}\n.camera-tip {\n  color: #999;\n  font-size: 32rpx;\n  background-color: rgba(0,0,0,0.3);\n  padding: 10rpx 20rpx;\n  border-radius: 8rpx;\n}\n.skeleton-overlay {\n  position: relative;\n  width: 200rpx;\n  height: 400rpx;\n  display: flex;\n  justify-content: center;\n  align-items: center;\n}\n.skeleton-box {\n  width: 200rpx;\n  height: 400rpx;\n  border-width: 2px;\n  border-style: dashed;\n  border-color: #20C997;\n  background-color: transparent;\n}\n.debug-info {\n  position: absolute;\n  bottom: 20rpx;\n  left: 20rpx;\n  font-size: 24rpx;\n  color: #0f0;\n  background-color: rgba(0,0,0,0.5);\n  padding: 8rpx;\n  border-radius: 4rpx;\n}\n.dashboard {\n  flex: 1;\n  background: #2c3e50;\n  display: flex;\n  justify-content: space-around;\n  align-items: center;\n  padding: 20rpx;\n}\n.counter-box, .status-box {\n  display: flex;\n  flex-direction: column;\n  align-items: center;\n}\n.count-val { font-size: 80rpx; font-weight: bold; color: #20C997; }\n.count-label { font-size: 28rpx; color: #ccc; }\n.status-val { font-size: 36rpx; font-weight: bold; margin-top: 10rpx; }\n.status-val.normal { color: #fff; }\n.status-val.success { color: #20C997; }\n.status-val.warn { color: #d81e06; }\n.status-label { font-size: 28rpx; color: #ccc; }\n\n.controls {\n  padding: 30rpx;\n  background: #fff;\n  border-top-left-radius: 30rpx;\n  border-top-right-radius: 30rpx;\n  margin-top: -30rpx;\n  z-index: 10;\n}\n.btn-start { background: #20C997; color: #fff; border-radius: 50rpx; }\n.btn-stop { background: #d81e06; color: #fff; border-radius: 50rpx; }\n\n.simulation-tools {\n  margin-top: 30rpx;\n  border-top: 1px solid #eee;\n  padding-top: 20rpx;\n}\n.tool-title { font-size: 26rpx; color: #666; display: block; margin-bottom: 15rpx; }\n.tool-btns { display: flex; flex-wrap: wrap; gap: 15rpx; }\n\n@keyframes pulse {\n  0% { border-color: #20C997; box-shadow: 0 0 10rpx #20C997; }\n  50% { border-color: #fff; box-shadow: 0 0 20rpx #fff; }\n  100% { border-color: #20C997; box-shadow: 0 0 10rpx #20C997; }\n}\n</style>","import MiniProgramPage from 'D:/PC/Document/HBuilderProjects/campus-system/fronted/pages/ai-police/ai-police.vue'\nwx.createPage(MiniProgramPage)"],"names":["ref","uni"],"mappings":";;;;;AAsEA,UAAM,cAAcA,cAAAA,IAAI,KAAK;AAC7B,UAAM,QAAQA,cAAAA,IAAI,CAAC;AACnB,UAAM,aAAaA,cAAAA,IAAI,MAAM;AAC7B,UAAM,cAAcA,cAAAA,IAAI,QAAQ;AAChC,UAAM,aAAaA,cAAAA,IAAI,CAAC;AACxB,UAAM,UAAUA,cAAAA,IAAI,UAAU;AAE9B,QAAI,QAAQ;AA0DZ,UAAM,cAAc,MAAM;AACxB,kBAAY,QAAQ;AACpB,iBAAW,QAAQ;AACnB,kBAAY,QAAQ;AACpB,YAAM,QAAQ;AACd;IACF;AAEA,UAAM,aAAa,MAAM;AACvB,kBAAY,QAAQ;AACpB,iBAAW,QAAQ;AACnB,oBAAc,KAAK;AAEnBC,oBAAAA,MAAI,UAAU;AAAA,QACZ,OAAO;AAAA,QACP,SAAS,WAAW,MAAM,KAAK;AAAA,QAC/B,aAAa;AAAA,QACb,YAAY;AAAA,QACZ,SAAS,CAAC,QAAQ;AAChB,cAAI,IAAI,SAAS;AACfA,0BAAAA,MAAI,YAAY,EAAE,OAAO,UAAW,CAAA;AACpC,uBAAW,MAAM;AACbA,4BAAG,MAAC,YAAW;AACfA,4BAAAA,MAAI,WAAW;AAAA,gBACb,KAAK,uDAAuD,MAAM,KAAK;AAAA,cACrF,CAAa;AAAA,YACJ,GAAE,GAAG;AAAA,UACP;AAAA,QACF;AAAA,MACL,CAAG;AAAA,IACH;AAEA,UAAM,sBAAsB,MAAM;AAChC,cAAQ,YAAY,MAAM;AAExB,mBAAW,SAAS,KAAK,KAAK,OAAM,IAAK,GAAG,QAAQ,CAAC;AAAA,MACtD,GAAE,GAAI;AAAA,IACT;AAEA,UAAM,iBAAiB,MAAM;AAC3B,UAAI,CAAC;AAAa;AAClB,iBAAW,QAAQ;AACnB,kBAAY,QAAQ;AACpB,cAAQ,QAAQ;AAChB,iBAAW,MAAM;AACf,cAAM;AACN,gBAAQ,QAAQ;AAChB,mBAAW,QAAQ;AACnB,oBAAY,QAAQ;AAAA,MACrB,GAAE,GAAG;AAAA,IACR;AAEA,UAAM,WAAW,CAAC,SAAS;AACzB,UAAI,CAAC;AAAa;AAClB,iBAAW,QAAQ,MAAM,IAAI;AAC7B,kBAAY,QAAQ;AACpB,iBAAW,SAAS,KAAK,OAAQ,IAAG,IAAI,QAAQ,CAAC;AAEjDA,oBAAG,MAAC,YAAW;AACfA,oBAAAA,MAAI,UAAU;AAAA,QACZ,OAAO,SAAS,IAAI;AAAA,QACpB,MAAM;AAAA,QACN,UAAU;AAAA,MACd,CAAG;AAED,iBAAW,MAAM;AACf,mBAAW,QAAQ;AACnB,oBAAY,QAAQ;AACpB,mBAAW,QAAQ;AAAA,MACpB,GAAE,GAAI;AAAA,IACT;AAEA,UAAM,oBAAoB,CAAC,MAAM;AAC/BA,iFAAc,iBAAiB,CAAC;AAChC,UAAI,MAAM;AACV,UAAI,EAAE,SAAS,qBAAqB,EAAE,YAAY,qBAAqB;AACrE,cAAM;AAAA,MACV,WAAa,EAAE,SAAS,iBAAiB;AACrC,cAAM;AAAA,MACV,WAAa,EAAE,SAAS,qBAAqB;AACzC,cAAM;AAAA,MACP;AAEDA,oBAAAA,MAAI,UAAU;AAAA,QACZ,OAAO;AAAA,QACP,MAAM;AAAA,QACN,UAAU;AAAA,MACd,CAAG;AAAA,IACH;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AC9NA,GAAG,WAAW,eAAe;"}