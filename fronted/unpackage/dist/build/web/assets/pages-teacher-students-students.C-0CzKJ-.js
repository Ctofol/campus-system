import{r as e,z as a,a as l,s as t,h as s,c,w as u,i as n,o,d,e as i,q as r,t as f,f as _,j as v,k as p,F as m,l as h,X as k,J as y,K as g,$ as b,L as x,p as C,I as w,a0 as j,a1 as T,v as z,S as L,n as $,m as I}from"./index-C5iLBQvu.js";import{c as P,o as S}from"./uni-app.es.BEWjhZNk.js";import{r as U,B}from"./request.BfbRFve_.js";import{_ as D}from"./_plugin-vue_export-helper.BCo6x5W8.js";const E=D({__name:"students",setup(D){const E=e(!1),N=e([]),O=e([]),q=e(!1),R=e(!1),G=e([]),V=e([]),A=e(""),F=e(1),J=e(!0),K=e(!1),X=e([]),H=a((()=>["å…¨éƒ¨ç­çº§",...X.value.map((e=>e.name))])),M=e(""),Q=e(null),W=["å…¨éƒ¨çŠ¶æ€","æ­£å¸¸","è¯·å‡","å—ä¼¤"],Y=e(""),Z=e(null),ee=["ä½“èƒ½Aç»„","ä½“èƒ½Bç»„","åº·å¤ç»„"],ae=["å…¨éƒ¨å°ç»„",...ee],le=e(""),te=a((()=>G.value)),se=a((()=>G.value.length)),ce=a((()=>G.value.filter((e=>"normal"!==e.health_status)).length)),ue=a((()=>G.value.filter((e=>"normal"===e.health_status)).length)),ne=a((()=>te.value.length>0&&N.value.length===te.value.length)),oe=async(e=!1)=>{if(e&&(F.value=1,J.value=!0,G.value=[]),J.value&&!K.value){K.value=!0;try{const e={page:F.value,size:20};Q.value&&(e.class_id=Q.value),A.value&&(e.name=A.value),Z.value&&(e.status=Z.value),le.value&&(e.group_name=le.value);const a=(await U("/teacher/students",{method:"GET",data:e})).map((e=>{let a="æœªåˆ†é…";if(e.class_id){const l=X.value.find((a=>a.id===e.class_id));l&&(a=l.name)}let l="æ­£å¸¸",t="ok";return"leave"===e.health_status&&(l="è¯·å‡",t="warn"),"injured"===e.health_status&&(l="å—ä¼¤",t="warn"),{...e,className:a,statusLabel:l,statusClass:t,expanded:!1}}));a.length<20&&(J.value=!1),G.value=[...G.value,...a],F.value++}catch(a){console.error(a),t({title:"åŠ è½½å¤±è´¥",icon:"none"})}finally{K.value=!1}}};P((()=>{oe(!1)}));const de=async()=>{try{const e=await U("/teacher/health/requests",{method:"GET"});V.value=e}catch(e){console.error(e)}};S((()=>{if("teacher"!==(l("userRole")||l("role")))return t({title:"è¯·ä½¿ç”¨æ•™å¸ˆè´¦å·ç™»å½•",icon:"none"}),void s({url:"/pages/login/login"});(async()=>{try{const e=await U("/teacher/classes",{method:"GET"});X.value=e}catch(e){console.error(e)}})().then((()=>{oe(!0)})),de(),O.value=l("mockSharedReports")||[]}));const ie=e=>{const a=e.detail.value;0==a?(M.value="",Q.value=null):(M.value=H.value[a],Q.value=X.value[a-1].id),oe(!0)},re=e=>{const a=e.detail.value;le.value=0==a?"":ae[a],oe(!0)},fe=e=>{const a=e.detail.value;Y.value=W[a],0==a?Z.value=null:1==a?Z.value="normal":2==a?Z.value="leave":3==a&&(Z.value="injured"),oe(!0)},_e=()=>{E.value=!E.value,N.value=[],E.value&&G.value.forEach((e=>e.expanded=!1))},ve=e=>{const a=N.value.indexOf(e.id);a>-1?N.value.splice(a,1):N.value.push(e.id)},pe=()=>{ne.value?N.value=[]:N.value=te.value.map((e=>e.id))},me=()=>{if(0===N.value.length)return t({title:"è¯·å…ˆé€‰æ‹©å­¦å‘˜",icon:"none"});k({itemList:ee,success:async e=>{const a=ee[e.tapIndex];try{await U("/teacher/students/bulk-update",{method:"POST",data:{student_ids:N.value,group_name:a}}),t({title:"æ‰¹é‡åˆ†ç»„æˆåŠŸ",icon:"success"}),oe(!0),_e()}catch(l){t({title:"æ“ä½œå¤±è´¥",icon:"none"})}}})},he=()=>{if(0===N.value.length)return t({title:"è¯·å…ˆé€‰æ‹©å­¦å‘˜",icon:"none"});const e=["normal","leave","injured"];k({itemList:["æ¢å¤æ­£å¸¸","æ ‡è®°è¯·å‡","æ ‡è®°å—ä¼¤"],success:async a=>{const l=e[a.tapIndex];try{await U("/teacher/students/bulk-update",{method:"POST",data:{student_ids:N.value,health_status:l}}),t({title:"çŠ¶æ€æ›´æ–°æˆåŠŸ",icon:"success"}),oe(!0),_e()}catch(s){t({title:"æ“ä½œå¤±è´¥",icon:"none"})}}})},ke=()=>{N.value.length>0?ye({student_ids:N.value}):y({title:"å¯¼å‡ºç¡®è®¤",content:"æœªé€‰æ‹©å­¦å‘˜ï¼Œæ˜¯å¦å¯¼å‡ºå½“å‰ç­›é€‰æ¡ä»¶ä¸‹çš„æ‰€æœ‰å­¦å‘˜ï¼Ÿ",success:e=>{if(e.confirm){const e={};Q.value&&(e.class_id=Q.value),Z.value&&(e.health_status=Z.value),le.value&&(e.group_name=le.value),ye(e)}}})},ye=e=>{g({title:"ç”ŸæˆæŠ¥è¡¨ä¸­..."});const a=l("token");b({url:`${B}/teacher/students/export`,method:"POST",header:{Authorization:`Bearer ${a}`,"Content-Type":"application/json"},data:e,responseType:"arraybuffer",success:e=>{if(x(),200===e.statusCode){if("undefined"!=typeof window&&window.Blob){const a=new Blob([e.data],{type:"text/csv"}),l=document.createElement("a");l.href=window.URL.createObjectURL(a),l.download=`students_export_${(new Date).getTime()}.csv`,l.click()}t({title:"å¯¼å‡ºæˆåŠŸ",icon:"success"}),E.value&&_e()}else t({title:"å¯¼å‡ºå¤±è´¥",icon:"none"})},fail:()=>{x(),t({title:"è¯·æ±‚å¤±è´¥",icon:"none"})}})},ge=async(e,a,l)=>{try{await U(`/teacher/students/${e}`,{method:"PUT",data:{health_status:a,abnormal_reason:l}}),t({title:"å·²æ›´æ–°",icon:"success"}),oe(!0)}catch(s){console.error(s)}},be=e=>{const a=G.value.find((a=>a.id===e));return a?a.name:`æœªçŸ¥å­¦å‘˜(${e})`},xe=async(e,a)=>{try{await U(`/teacher/health/requests/${e.id}/review`,{method:"PUT",data:{status:a}}),t({title:"å·²å¤„ç†",icon:"success"}),de(),oe()}catch(l){t({title:"å¤„ç†å¤±è´¥",icon:"none"})}};return(e,a)=>{const l=C,s=n,g=w,b=j,x=T,P=z,S=L;return o(),c(s,{class:"students-page"},{default:u((()=>[d(s,{class:"header"},{default:u((()=>[d(s,{class:"nav-row"},{default:u((()=>[d(l,{class:"page-title"},{default:u((()=>[i("å­¦å‘˜ç®¡ç†")])),_:1}),d(s,{class:r(["batch-btn",{active:E.value}]),onClick:_e},{default:u((()=>[d(l,null,{default:u((()=>[i(f(E.value?"å®Œæˆ":"æ‰¹é‡ç®¡ç†"),1)])),_:1})])),_:1},8,["class"])])),_:1}),d(s,{class:"stats-row"},{default:u((()=>[d(s,{class:"stat-item"},{default:u((()=>[d(l,{class:"stat-num"},{default:u((()=>[i(f(se.value),1)])),_:1}),d(l,{class:"stat-label"},{default:u((()=>[i("æ€»äººæ•°")])),_:1})])),_:1}),d(s,{class:"stat-item warn"},{default:u((()=>[d(l,{class:"stat-num"},{default:u((()=>[i(f(ce.value),1)])),_:1}),d(l,{class:"stat-label"},{default:u((()=>[i("å¼‚å¸¸")])),_:1})])),_:1}),d(s,{class:"stat-item success"},{default:u((()=>[d(l,{class:"stat-num"},{default:u((()=>[i(f(ue.value),1)])),_:1}),d(l,{class:"stat-label"},{default:u((()=>[i("æ­£å¸¸")])),_:1})])),_:1})])),_:1}),d(s,{class:"tools-section"},{default:u((()=>[d(s,{class:"search-bar"},{default:u((()=>[d(l,{class:"search-icon"},{default:u((()=>[i("ğŸ”")])),_:1}),d(g,{modelValue:A.value,"onUpdate:modelValue":a[0]||(a[0]=e=>A.value=e),class:"search-input",placeholder:"æœç´¢å§“å/å­¦å·...","confirm-type":"search",onConfirm:oe},null,8,["modelValue"])])),_:1}),d(s,{class:"filters-bar"},{default:u((()=>[d(b,{mode:"selector",range:H.value,onChange:ie,class:"filter-item"},{default:u((()=>[d(s,{class:"picker-box"},{default:u((()=>[d(l,{class:"picker-text"},{default:u((()=>[i(f(M.value||"å…¨éƒ¨ç­çº§"),1)])),_:1}),d(l,{class:"picker-icon"},{default:u((()=>[i("â–¼")])),_:1})])),_:1})])),_:1},8,["range"]),d(b,{mode:"selector",range:ae,onChange:re,class:"filter-item"},{default:u((()=>[d(s,{class:"picker-box"},{default:u((()=>[d(l,{class:"picker-text"},{default:u((()=>[i(f(le.value||"å…¨éƒ¨å°ç»„"),1)])),_:1}),d(l,{class:"picker-icon"},{default:u((()=>[i("â–¼")])),_:1})])),_:1})])),_:1}),d(b,{mode:"selector",range:W,onChange:fe,class:"filter-item"},{default:u((()=>[d(s,{class:"picker-box"},{default:u((()=>[d(l,{class:"picker-text"},{default:u((()=>[i(f(Y.value||"å…¨éƒ¨çŠ¶æ€"),1)])),_:1}),d(l,{class:"picker-icon"},{default:u((()=>[i("â–¼")])),_:1})])),_:1})])),_:1})])),_:1})])),_:1}),V.value.length>0?(o(),c(s,{key:0,class:"notice-bar",onClick:a[1]||(a[1]=e=>R.value=!0)},{default:u((()=>[d(s,{class:"notice-content"},{default:u((()=>[d(l,{class:"notice-icon"},{default:u((()=>[i("ğŸ””")])),_:1}),d(l,null,{default:u((()=>[i("æœ‰ "+f(V.value.length)+" æ¡å¾…å®¡æ‰¹ç”³è¯·",1)])),_:1})])),_:1}),d(l,{class:"arrow"},{default:u((()=>[i("å»å¤„ç† >")])),_:1})])),_:1})):_("",!0)])),_:1}),O.value.length>0?(o(),c(s,{key:0,class:"report-notice",onClick:a[2]||(a[2]=e=>q.value=!0)},{default:u((()=>[d(s,{class:"notice-left"},{default:u((()=>[d(l,{class:"notice-icon"},{default:u((()=>[i("ğŸ¤–")])),_:1}),d(l,{class:"notice-text"},{default:u((()=>[i("æ”¶åˆ° "+f(O.value.length)+" ä»½æ–°çš„è¿åŠ¨åˆ†ææŠ¥å‘Š",1)])),_:1})])),_:1}),d(l,{class:"notice-arrow"},{default:u((()=>[i("æŸ¥çœ‹ >")])),_:1})])),_:1})):_("",!0),d(s,{class:r(["card-list",{"has-bottom-bar":E.value}])},{default:u((()=>[(o(!0),v(m,null,p(te.value,((e,a)=>(o(),c(s,{class:"student-card",key:e.id,onClick:a=>(e=>{E.value?ve(e):e.expanded=!e.expanded})(e)},{default:u((()=>[d(s,{class:"card-main"},{default:u((()=>[d(s,{class:"card-left"},{default:u((()=>[E.value?(o(),c(x,{key:0,checked:N.value.includes(e.id),onClick:h((a=>ve(e)),["stop"]),color:"#20C997",style:{transform:"scale(0.8)"}},null,8,["checked","onClick"])):_("",!0),d(s,{class:"avatar"},{default:u((()=>[i(f(e.name.slice(0,1)),1)])),_:2},1024),d(s,{class:"info"},{default:u((()=>[d(l,{class:"name"},{default:u((()=>[i(f(e.name)+" ",1),e.groupName?(o(),c(l,{key:0,class:"group-tag"},{default:u((()=>[i("("+f(e.groupName)+")",1)])),_:2},1024)):_("",!0)])),_:2},1024),d(l,{class:"meta"},{default:u((()=>[i("å­¦å·ï¼š"+f(e.student_id||"æœªå½•å…¥"),1)])),_:2},1024),d(l,{class:"meta"},{default:u((()=>[i("ç­çº§ï¼š"+f(e.className),1)])),_:2},1024),d(l,{class:"meta"},{default:u((()=>[i(f("normal"===e.health_status?"å¥åº·ï¼šè‰¯å¥½":"åŸå› ï¼š"+(e.abnormal_reason||"æœªè¯´æ˜")),1)])),_:2},1024)])),_:2},1024)])),_:2},1024),d(s,{class:"card-right"},{default:u((()=>[d(l,{class:r(["status",e.statusClass])},{default:u((()=>[i(f(e.statusLabel),1)])),_:2},1032,["class"]),E.value?_("",!0):(o(),c(l,{key:0,class:"expand-icon"},{default:u((()=>[i(f(e.expanded?"â–²":"â–¼"),1)])),_:2},1024))])),_:2},1024)])),_:2},1024),e.expanded&&!E.value?(o(),c(s,{key:0,class:"card-expanded"},{default:u((()=>[d(s,{class:"exp-grid"},{default:u((()=>[d(s,{class:"exp-item"},{default:u((()=>[d(l,{class:"exp-label"},{default:u((()=>[i("çŠ¶æ€")])),_:1}),d(l,{class:"exp-val"},{default:u((()=>[i(f(e.statusLabel),1)])),_:2},1024)])),_:2},1024),d(s,{class:"exp-item"},{default:u((()=>[d(l,{class:"exp-label"},{default:u((()=>[i("åŸå› ")])),_:1}),d(l,{class:"exp-val"},{default:u((()=>[i(f(e.abnormal_reason||"-"),1)])),_:2},1024)])),_:2},1024)])),_:2},1024),d(s,{class:"exp-actions"},{default:u((()=>[d(P,{size:"mini",class:"exp-btn",onClick:h((a=>(e=>{I({url:`/pages/teacher/students/detail?id=${e.id}`})})(e)),["stop"])},{default:u((()=>[i("å®Œæ•´æ¡£æ¡ˆ")])),_:2},1032,["onClick"]),d(P,{size:"mini",class:"exp-btn outline",onClick:h((a=>(e=>{k({itemList:["ä¿®æ”¹çŠ¶æ€: æ­£å¸¸","ä¿®æ”¹çŠ¶æ€: è¯·å‡","ä¿®æ”¹çŠ¶æ€: å—ä¼¤","ä¿®æ”¹åˆ†ç»„"],success:async a=>{if(a.tapIndex<3){const l=["normal","leave","injured"][a.tapIndex];"normal"!==l?y({title:"å¼‚å¸¸åŸå› ",editable:!0,placeholder:"è¯·è¾“å…¥åŸå› ï¼ˆå¦‚ï¼šæ„Ÿå†’ã€æ‰­ä¼¤ï¼‰",success:async a=>{a.confirm&&await ge(e.id,l,a.content)}}):await ge(e.id,l,"")}else k({itemList:ee,success:async a=>{await U(`/teacher/students/${e.id}`,{method:"PUT",data:{group_name:ee[a.tapIndex]}}),t({title:"å·²æ›´æ–°",icon:"success"}),oe(!0)}})}})})(e)),["stop"])},{default:u((()=>[i("ç¼–è¾‘ä¿¡æ¯")])),_:2},1032,["onClick"])])),_:2},1024)])),_:2},1024)):_("",!0)])),_:2},1032,["onClick"])))),128)),0===te.value.length?(o(),c(s,{key:0,class:"empty"},{default:u((()=>[d(l,null,{default:u((()=>[i("æš‚æ— ç¬¦åˆæ¡ä»¶çš„å­¦å‘˜")])),_:1})])),_:1})):_("",!0)])),_:1},8,["class"]),E.value?(o(),c(s,{key:1,class:"batch-bar"},{default:u((()=>[d(s,{class:"batch-info"},{default:u((()=>[d(x,{checked:ne.value,onClick:pe,color:"#20C997",style:{transform:"scale(0.8)"}},null,8,["checked"]),d(l,null,{default:u((()=>[i("å·²é€‰ "+f(N.value.length)+" äºº",1)])),_:1})])),_:1}),d(s,{class:"batch-actions"},{default:u((()=>[d(P,{size:"mini",class:"action-btn outline",onClick:me},{default:u((()=>[i("æ‰¹é‡åˆ†ç»„")])),_:1}),d(P,{size:"mini",class:"action-btn warn",onClick:he},{default:u((()=>[i("æ›´æ–°çŠ¶æ€")])),_:1}),d(P,{size:"mini",class:"action-btn",onClick:ke},{default:u((()=>[i("å¯¼å‡ºæ•°æ®")])),_:1})])),_:1})])),_:1})):_("",!0),R.value?(o(),c(s,{key:2,class:"modal-overlay",onClick:a[5]||(a[5]=e=>R.value=!1)},{default:u((()=>[d(s,{class:"report-modal",onClick:a[4]||(a[4]=h((()=>{}),["stop"]))},{default:u((()=>[d(s,{class:"modal-header"},{default:u((()=>[d(l,{class:"modal-title"},{default:u((()=>[i("ğŸ”” è¯·å‡/ä¼¤ç—…å®¡æ‰¹")])),_:1}),d(l,{class:"close-btn",onClick:a[3]||(a[3]=e=>R.value=!1)},{default:u((()=>[i("Ã—")])),_:1})])),_:1}),d(S,{"scroll-y":"",class:"report-list"},{default:u((()=>[(o(!0),v(m,null,p(V.value,((e,a)=>(o(),c(s,{class:"report-item",key:e.id},{default:u((()=>[d(s,{class:"report-meta"},{default:u((()=>[d(l,{class:"report-stu"},{default:u((()=>[i(f(be(e.student_id)),1)])),_:2},1024),d(l,{class:"report-time"},{default:u((()=>{return[i(f((a=e.created_at,a?new Date(a).toLocaleDateString():"")),1)];var a})),_:2},1024)])),_:2},1024),d(s,{class:r(["report-card",e.type])},{default:u((()=>[d(s,{class:"card-header"},{default:u((()=>[d(l,{class:r(["report-type-tag",e.type])},{default:u((()=>[i(f("leave"===e.type?"ğŸ“… è¯·å‡ç”³è¯·":"ğŸ¥ ä¼¤ç—…æŠ¥å‘Š"),1)])),_:2},1032,["class"])])),_:2},1024),d(l,{class:"report-content"},{default:u((()=>[i(f(e.reason),1)])),_:2},1024)])),_:2},1032,["class"]),d(s,{class:"report-actions"},{default:u((()=>[d(P,{size:"mini",class:"action-btn reject",onClick:a=>xe(e,"rejected")},{default:u((()=>[i("é©³å›")])),_:2},1032,["onClick"]),d(P,{size:"mini",class:"action-btn approve",onClick:a=>xe(e,"approved")},{default:u((()=>[i("æ‰¹å‡†")])),_:2},1032,["onClick"])])),_:2},1024)])),_:2},1024)))),128)),0===V.value.length?(o(),c(s,{key:0,class:"empty"},{default:u((()=>[d(l,null,{default:u((()=>[i("æš‚æ— å¾…å®¡æ‰¹è¯·æ±‚")])),_:1})])),_:1})):_("",!0)])),_:1})])),_:1})])),_:1})):_("",!0),q.value?(o(),c(s,{key:3,class:"modal-overlay",onClick:a[8]||(a[8]=e=>q.value=!1)},{default:u((()=>[d(s,{class:"report-modal",onClick:a[7]||(a[7]=h((()=>{}),["stop"]))},{default:u((()=>[d(s,{class:"modal-header"},{default:u((()=>[d(l,{class:"modal-title"},{default:u((()=>[i("ğŸ“„ å­¦å‘˜è¿åŠ¨åˆ†ææŠ¥å‘Š")])),_:1}),d(l,{class:"close-btn",onClick:a[6]||(a[6]=e=>q.value=!1)},{default:u((()=>[i("Ã—")])),_:1})])),_:1}),d(S,{"scroll-y":"",class:"report-list"},{default:u((()=>[(o(!0),v(m,null,p(O.value,((e,a)=>(o(),c(s,{class:"report-item",key:a},{default:u((()=>[d(s,{class:"report-meta"},{default:u((()=>[d(l,{class:"report-stu"},{default:u((()=>[i(f(e.studentName),1)])),_:2},1024),d(l,{class:"report-time"},{default:u((()=>[i(f(e.time),1)])),_:2},1024)])),_:2},1024),d(s,{class:"report-card"},{default:u((()=>[d(l,{class:"report-title"},{default:u((()=>[i(f(e.card.title),1)])),_:2},1024),e.card.suggestion?(o(),c(l,{key:0,class:"report-suggestion"},{default:u((()=>[i("ğŸ’¡ "+f(e.card.suggestion),1)])),_:2},1024)):_("",!0),e.card.chartData?(o(),c(s,{key:1,class:"report-chart"},{default:u((()=>[(o(!0),v(m,null,p(e.card.chartData,((e,a)=>(o(),c(s,{class:"mini-bar",key:a},{default:u((()=>[d(l,{class:"mini-label"},{default:u((()=>[i(f(e.label),1)])),_:2},1024),d(s,{class:"mini-track"},{default:u((()=>[d(s,{class:"mini-fill",style:$({width:e.value+"%",background:e.color})},null,8,["style"])])),_:2},1024),d(l,{class:"mini-val"},{default:u((()=>[i(f(e.valText),1)])),_:2},1024)])),_:2},1024)))),128))])),_:2},1024)):_("",!0)])),_:2},1024),d(s,{class:"report-actions"},{default:u((()=>[d(P,{size:"mini",class:"reply-btn",onClick:e=>{}},{default:u((()=>[i("å›å¤æŒ‡å¯¼")])),_:2},1032,["onClick"])])),_:2},1024)])),_:2},1024)))),128))])),_:1})])),_:1})])),_:1})):_("",!0)])),_:1})}}},[["__scopeId","data-v-d322befa"]]);export{E as default};
