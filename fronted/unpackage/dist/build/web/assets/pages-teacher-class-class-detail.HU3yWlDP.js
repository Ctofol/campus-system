import{r as a,p as e,c as l,w as t,i as s,o as u,d as i,e as c,t as d,j as n,f as o,h as r,F as f,q as v,u as _,a3 as m,I as p,l as k,m as y,J as h}from"./index-D4dSIJeF.js";import{a as w}from"./uni-app.es.DJB9Vm6C.js";import{r as g}from"./request.Da1Pdojv.js";import{_ as C}from"./_plugin-vue_export-helper.BCo6x5W8.js";const b=C({__name:"class-detail",setup(C){const b=a(null),$=a(null),j=a(null),x=a([]),z=a(!1),S=a(""),D=a([]),E=a([]),F=a(-1),I=a(""),O=a("");w((a=>{a.id&&(b.value=a.id,q(),V())}));const V=async()=>{try{const a=await g({url:"/teacher/tasks",data:{size:100}});D.value=a.items,E.value=[{title:"全部任务",id:null},...a.items]}catch(a){console.error("Fetch tasks failed",a)}},q=async()=>{if(b.value)try{const a=await g({url:`/teacher/classes/${b.value}`});$.value=a,await T()}catch(a){e({title:"加载失败",icon:"none"})}},T=async()=>{if(b.value)try{const a={};if(F.value>-1){const e=E.value[F.value].id;e&&(a.task_id=e)}I.value&&(a.start_date=new Date(I.value).toISOString()),O.value&&(a.end_date=new Date(O.value).toISOString());const e=await g({url:`/teacher/classes/${b.value}/stats`,data:a});j.value=e,x.value=e.student_stats}catch(a){e({title:"统计加载失败",icon:"none"})}},B=a=>{F.value=a.detail.value},J=a=>{I.value=a.detail.value},L=a=>{O.value=a.detail.value},P=async()=>{if(S.value)try{await g({url:`/teacher/classes/${b.value}/students`,method:"POST",data:{phone:S.value}}),z.value=!1,S.value="",q(),e({title:"添加成功",icon:"success"})}catch(a){e({title:"添加失败: "+(a.message||"找不到学生"),icon:"none"})}};return(a,w)=>{const C=v,D=s,V=_,U=m,A=p;return u(),l(D,{class:"container"},{default:t((()=>[$.value?(u(),l(D,{key:0,class:"header"},{default:t((()=>[i(D,null,{default:t((()=>[i(C,{class:"title"},{default:t((()=>[c(d($.value.name),1)])),_:1}),i(C,{class:"sub-title"},{default:t((()=>[c(d($.value.student_count)+" 名学生",1)])),_:1})])),_:1}),i(V,{size:"mini",type:"primary",onClick:w[0]||(w[0]=a=>z.value=!0)},{default:t((()=>[c("+ 添加学生")])),_:1})])),_:1})):n("",!0),j.value?(u(),l(D,{key:1,class:"stats-card"},{default:t((()=>[i(D,{class:"stat-item"},{default:t((()=>[i(C,{class:"val"},{default:t((()=>[c(d(j.value.total_distance?j.value.total_distance.toFixed(1):"0.0"),1)])),_:1}),i(C,{class:"label"},{default:t((()=>[c("总里程 (km)")])),_:1})])),_:1}),i(D,{class:"stat-item"},{default:t((()=>[i(C,{class:"val"},{default:t((()=>[c(d(j.value.total_activities),1)])),_:1}),i(C,{class:"label"},{default:t((()=>[c("总运动次数")])),_:1})])),_:1})])),_:1})):n("",!0),i(D,{class:"filter-card"},{default:t((()=>[i(D,{class:"filter-row"},{default:t((()=>[i(U,{class:"filter-picker",range:E.value,"range-key":"title",onChange:B},{default:t((()=>[i(D,{class:"picker-view"},{default:t((()=>[i(C,null,{default:t((()=>[c("任务筛选:")])),_:1}),i(C,{class:"picker-val"},{default:t((()=>[c(d(F.value>-1?E.value[F.value].title:"全部任务"),1)])),_:1})])),_:1})])),_:1},8,["range"])])),_:1}),i(D,{class:"filter-row date-row"},{default:t((()=>[i(U,{mode:"date",onChange:J},{default:t((()=>[i(D,{class:"date-picker"},{default:t((()=>[c(d(I.value||"开始日期"),1)])),_:1})])),_:1}),i(C,{class:"sep"},{default:t((()=>[c("至")])),_:1}),i(U,{mode:"date",onChange:L},{default:t((()=>[i(D,{class:"date-picker"},{default:t((()=>[c(d(O.value||"结束日期"),1)])),_:1})])),_:1})])),_:1}),i(V,{class:"filter-btn",type:"default",size:"mini",onClick:T},{default:t((()=>[c("应用筛选")])),_:1})])),_:1}),i(D,{class:"list-title"},{default:t((()=>[c("学生列表")])),_:1}),i(D,{class:"student-list"},{default:t((()=>[(u(!0),o(f,null,r(x.value,(a=>(u(),l(D,{class:"student-item",key:a.id,onClick:e=>{return l=a.id,void y({url:`/pages/teacher/students/detail?id=${l}`});var l}},{default:t((()=>[i(D,{class:"info"},{default:t((()=>[i(C,{class:"name"},{default:t((()=>[c(d(a.name),1)])),_:2},1024),i(C,{class:"detail"},{default:t((()=>[c("里程: "+d(a.distance?a.distance.toFixed(1):"0.0")+"km | 次数: "+d(a.count),1)])),_:2},1024)])),_:2},1024),i(C,{class:"remove-btn",onClick:k((l=>(async a=>{a.id&&h({title:"确认移除",content:`确定将 ${a.name} 移出班级吗？`,success:async l=>{if(l.confirm)try{await g({url:`/teacher/classes/${b.value}/students/${a.id}`,method:"DELETE"}),q()}catch(t){e({title:"移除失败",icon:"none"})}}})})(a)),["stop"])},{default:t((()=>[c("移除")])),_:2},1032,["onClick"])])),_:2},1032,["onClick"])))),128)),0===x.value.length?(u(),l(D,{key:0,class:"empty-tip"},{default:t((()=>[c("暂无学生")])),_:1})):n("",!0)])),_:1}),z.value?(u(),l(D,{key:2,class:"modal-mask"},{default:t((()=>[i(D,{class:"modal"},{default:t((()=>[i(D,{class:"modal-title"},{default:t((()=>[c("添加学生")])),_:1}),i(A,{class:"input",modelValue:S.value,"onUpdate:modelValue":w[1]||(w[1]=a=>S.value=a),placeholder:"请输入学生手机号",type:"number"},null,8,["modelValue"]),i(D,{class:"modal-btns"},{default:t((()=>[i(V,{size:"mini",onClick:w[2]||(w[2]=a=>z.value=!1)},{default:t((()=>[c("取消")])),_:1}),i(V,{size:"mini",type:"primary",onClick:P},{default:t((()=>[c("确定")])),_:1})])),_:1})])),_:1})])),_:1})):n("",!0)])),_:1})}}},[["__scopeId","data-v-4e20e7c3"]]);export{b as default};
