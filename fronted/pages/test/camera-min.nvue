<template>
  <view class="camera-min-page">
    <!-- 1. 顶部提示 -->
    <view class="status-bar" :style="{height: statusBarHeight + 'px'}"></view>
    <view class="header">
      <text class="title">摄像头最小可用测试</text>
      <text class="subtitle">仅用于检测 App 端摄像头画面是否正常</text>
    </view>

    <!-- 2. 核心区域：原生 Camera 组件 -->
    <!-- 
      要求：
      1. 直接渲染，不使用 v-if/v-show
      2. 宽高明确，避免布局塌陷
      3. 默认后置 (back)
    -->
    <view class="camera-container">
      <camera
        class="live-camera"
        device-position="back"
        flash="off"
        @error="handleCameraError"
      >
        <!-- 覆盖层：证明 camera 是原生层级 -->
        <cover-view class="camera-overlay">
          <text class="overlay-text">原生组件运行中</text>
        </cover-view>
      </camera>
    </view>

    <!-- 3. 调试信息 -->
    <view class="debug-info">
      <text class="info-item">状态：{{ statusMsg }}</text>
      <text class="info-item">权限：{{ authStatus }}</text>
    </view>

    <!-- 4. 简单控制 -->
    <button class="action-btn" @click="checkAuth">检查权限</button>
    <button class="action-btn secondary" @click="back">返回</button>
  </view>
</template>

<script>
export default {
  data() {
    return {
      statusBarHeight: 20,
      statusMsg: '初始化...',
      authStatus: '未知'
    }
  },
  onLoad() {
    const sys = uni.getSystemInfoSync();
    this.statusBarHeight = sys.statusBarHeight || 20;
    this.statusMsg = '页面已加载';
    
    // 自动检查权限
    this.checkAuth();
  },
  methods: {
    handleCameraError(e) {
      console.error('Camera Error:', e);
      this.statusMsg = '摄像头错误: ' + (e.detail.errMsg || '未知');
      uni.showToast({
        title: '摄像头启动失败',
        icon: 'none'
      });
    },
    checkAuth() {
      // App 端检查权限
      // #ifdef APP-PLUS
      const permission = uni.getAppAuthorizeSetting(); // 获取系统权限设置
      this.authStatus = permission.cameraAuthorized || '未检测到';
      
      if (permission.cameraAuthorized === 'denied') {
        this.statusMsg = '权限被拒绝';
        uni.showModal({
          title: '权限提示',
          content: '摄像头权限已被拒绝，请前往系统设置开启',
          confirmText: '去设置',
          success: (res) => {
            if (res.confirm) uni.openAppAuthorizeSetting();
          }
        });
      } else {
        this.statusMsg = '权限正常';
      }
      // #endif

      // #ifndef APP-PLUS
      this.authStatus = '非App环境';
      this.statusMsg = '请在真机App运行';
      // #endif
    },
    back() {
      uni.navigateBack();
    }
  }
}
</script>

<style>
.camera-min-page {
  flex: 1;
  background-color: #f5f5f5;
  flex-direction: column;
}

.status-bar {
  background-color: #ffffff;
}

.header {
  padding: 20px;
  background-color: #ffffff;
  border-bottom-width: 1px;
  border-bottom-color: #eeeeee;
}

.title {
  font-size: 18px;
  font-weight: bold;
  color: #333333;
}

.subtitle {
  font-size: 12px;
  color: #999999;
  margin-top: 5px;
}

.camera-container {
  width: 750rpx; /* 满宽 */
  height: 500rpx; /* 固定高度 */
  background-color: #000000;
  margin-top: 20px;
  position: relative;
}

.live-camera {
  width: 750rpx;
  height: 500rpx;
}

.camera-overlay {
  position: absolute;
  bottom: 20rpx;
  left: 20rpx;
  background-color: rgba(0,0,0,0.5);
  padding: 5px 10px;
  border-radius: 4px;
}

.overlay-text {
  color: #ffffff;
  font-size: 12px;
}

.debug-info {
  padding: 20px;
  margin-top: 10px;
  background-color: #ffffff;
}

.info-item {
  font-size: 14px;
  color: #666666;
  margin-bottom: 5px;
}

.action-btn {
  margin: 10px 20px;
  background-color: #20C997;
  border-radius: 8px;
  height: 44px;
  justify-content: center;
  align-items: center;
}

.secondary {
  background-color: #dddddd;
}
</style>