<template>
  <view class="test-page-root">
    <!-- Custom Navigation Bar -->
    <view class="custom-navbar" :style="{paddingTop: statusBarHeight + 'px'}">
      <view class="navbar-content">
        <text class="navbar-title">ä½“èƒ½æµ‹è¯•</text>
      </view>
    </view>
    
    <!-- Content Wrapper -->
    <scroll-view scroll-y="true" class="content-wrapper" :style="{paddingTop: (statusBarHeight + 44) + 'px'}">
      <view v-if="role === 'teacher'" class="teacher-tools">
        <view class="teacher-card">
          <text class="teacher-title">æ•™å¸ˆå·¥å…·</text>
          <view class="teacher-actions">
            <button class="teacher-btn" @click="gotoStudents"><text class="teacher-btn-text">å­¦å‘˜ç®¡ç†</text></button>
          </view>
        </view>
      </view>
      <view v-else class="student-container">
        <view class="header-info">
          <text class="project-name">{{ projectName }}</text>
          <view class="standard-badge">
            <text class="badge-text">å›½å®¶å­¦ç”Ÿä½“è´¨å¥åº·æ ‡å‡†</text>
          </view>
          <text class="standard-desc">åŠ¨ä½œæ ‡å‡†ï¼š{{ standardDesc }}</text>
          
          <view class="test-type-switch">
            <button class="switch-btn" @click="showTypeSelector"><text class="switch-btn-text">åˆ‡æ¢æµ‹è¯•ç±»å‹</text></button>
            <view class="type-selector" v-if="showSelector">
              <view class="type-item" @click="switchTestType('å¼•ä½“å‘ä¸Š', 'pull-up')"><text class="type-item-text">å¼•ä½“å‘ä¸Š</text></view>
              <view class="type-item" @click="switchTestType('ä»°å§èµ·å', 'sit-up')"><text class="type-item-text">ä»°å§èµ·å</text></view>
              <view class="type-item" @click="switchTestType('ä¿¯å§æ’‘', 'push-up')"><text class="type-item-text">ä¿¯å§æ’‘</text></view>
            </view>
          </view>
        </view>
      
        <view class="camera-area">
          <!-- #ifdef H5 -->
          <view class="h5-camera-wrapper">
            <!-- H5 specific implementation omitted for brevity in nvue if not targeting H5, but keeping for compatibility -->
            <text class="error-text">H5 not fully supported in nvue mode</text>
          </view>
          <!-- #endif -->

          <!-- #ifndef H5 -->
          <camera
            v-if="showCamera"
            class="real-camera"
            :device-position="cameraPosition"
            flash="off"
            @error="handleCameraError"
          ></camera>
          
          <view class="camera-controls" v-if="showCamera">
            <button class="switch-cam-btn" @click="toggleCamera">
               <text class="switch-text">ğŸ“· åˆ‡æ¢</text>
            </button>
          </view>
          
          <view v-if="!showCamera" class="camera-error-view">
             <text class="error-text">æ— æ³•è®¿é—®æ‘„åƒå¤´</text>
             <button class="retry-btn" @click="retryCamera"><text class="retry-text">é‡è¯•</text></button>
             <button class="retry-btn setting-btn" @click="openSysSettings" style="margin-top: 20rpx; background-color: #555;"><text class="retry-text">å»è®¾ç½®å¼€å¯æƒé™</text></button>
          </view>
          
          <!-- In nvue, standard view can overlay camera if placed after it -->
          <view class="camera-overlay-content" v-if="isTesting">
            <view class="count-overlay">
              <text class="count-val">{{ count }}</text>
              <text class="count-label">æ¬¡</text>
            </view>
            
            <view class="progress-bar-container">
              <view class="progress-fill" :style="{ width: progressPercent + '%' }"></view>
            </view>

            <view class="status-tips">
              <text class="status-text" :class="[isStandard ? 'valid-text' : '']">{{ statusText }}</text>
            </view>
          </view>
          <!-- #endif -->
        </view>
        
        <view class="action-area">
          <view class="timer-box">
            <text class="timer-label">{{ isTesting ? 'æµ‹è¯•ç”¨æ—¶' : (lastResult ? 'ä¸Šæ¬¡ç”¨æ—¶' : 'æµ‹è¯•ç”¨æ—¶') }}</text>
            <text class="timer-text">{{ isTesting ? formatTime(duration) : (lastResult ? lastResult.duration : '00:00') }}</text>
          </view>
          
          <!-- Last Result Display -->
          <view v-if="!isTesting && lastResult" class="last-result-box">
            <text class="result-title">ä¸Šæ¬¡æˆç»© ({{ projectName }})</text>
            <view class="result-row">
              <text class="result-label">æ•°é‡ï¼š</text>
              <text class="result-value">{{ lastResult.count }} æ¬¡</text>
            </view>
            <view class="result-row">
              <text class="result-label">ç”¨æ—¶ï¼š</text>
              <text class="result-value">{{ lastResult.duration }}</text>
            </view>
          </view>

          <view class="btn-group">
            <view v-if="!isTesting" class="main-btn start-btn" @click="startTest">
              <text class="btn-text">{{ lastResult ? 'å†æ¬¡æµ‹è¯•' : 'å¼€å§‹æµ‹è¯•' }}</text>
            </view>
            <view v-else class="testing-btns">
               <view class="sub-btn stop-btn" @click="endTest"><text class="btn-text">ç»“æŸæµ‹è¯•</text></view>
               <view class="sub-btn mock-btn" @click="mockCount"><text class="btn-text mock-text">+1 æ¨¡æ‹Ÿ</text></view>
            </view>
          </view>
        </view>
      </view>

      <!-- Guide Modal -->
      <view v-if="showGuide" class="guide-modal" @click="showGuide = false">
        <view class="guide-content" @click.stop>
          <text class="guide-title">åŠ¨ä½œæŒ‡å—</text>
          <view class="guide-visual">
            <text class="guide-emoji">{{ projectEmoji }}</text>
          </view>
          <text class="guide-desc">{{ standardDesc }}</text>
          <button class="guide-btn" @click="showGuide = false"><text class="guide-btn-text">æˆ‘çŸ¥é“äº†</text></button>
        </view>
      </view>
      
    </scroll-view>
  </view>
</template>

<script setup>
import { ref, computed, onMounted, onUnmounted } from 'vue';
import { onLoad } from '@dcloudio/uni-app';
import { request, BASE_URL } from '@/utils/request.js';

// çŠ¶æ€æ é«˜åº¦
const statusBarHeight = ref(20);
const cameraContext = ref(null);
const captureTimer = ref(null);
const isTesting = ref(false);
const count = ref(0);
const duration = ref(0);
const timer = ref(null);
const lastResult = ref(null);
const pendingVideoUrl = ref('');
const progressPercent = computed(() => Math.min((count.value / 20) * 100, 100)); // å‡è®¾ç›®æ ‡20ä¸ª
const isStandard = ref(false);
const statusText = ref('è¯·åšå¥½å‡†å¤‡');
const showSelector = ref(false);
const showGuide = ref(false);
const role = ref('student');
const showCamera = ref(true);
const cameraPosition = ref('back');

// é¡µé¢å‚æ•°
const projectName = ref('å¼•ä½“å‘ä¸Š');
const standardDesc = ref('ä¸‹é¢Œè¿‡æ ï¼ŒåŒè‡‚ä¼¸ç›´');
const testType = ref('pull-up');

const projectEmoji = computed(() => {
  const map = { 'pull-up': 'ğŸ’ª', 'sit-up': 'ğŸ§˜', 'push-up': 'ğŸ™‡' };
  return map[testType.value] || 'ğŸƒ';
});

const onPageShow = () => {
  const userRole = uni.getStorageSync('userRole') || 'student';
  role.value = userRole;
  
  // #ifndef H5
  if (!cameraContext.value && uni.createCameraContext) {
    cameraContext.value = uni.createCameraContext();
  }
  // #endif
};

const onPageHide = () => {
  if (isTesting.value) {
    clearInterval(timer.value);
    clearInterval(captureTimer.value);
    isTesting.value = false;
  }
};

onMounted(() => {
  onPageShow();
});

defineExpose({
  onPageShow,
  onPageHide
});

const showTypeSelector = () => {
  showSelector.value = !showSelector.value;
};

const switchTestType = (name, type) => {
  projectName.value = name;
  testType.value = type;
  showSelector.value = false;
  
  if (type === 'pull-up') standardDesc.value = 'ä¸‹é¢Œè¿‡æ ï¼ŒåŒè‡‚ä¼¸ç›´';
  else if (type === 'sit-up') standardDesc.value = 'åŒæ‰‹æŠ±å¤´ï¼Œè‚˜éƒ¨è§¦è†';
  else if (type === 'push-up') standardDesc.value = 'èº«ä½“å¹³ç›´ï¼Œå±ˆè‡‚90åº¦';
  
  count.value = 0;
  duration.value = 0;
  isTesting.value = false;
  statusText.value = 'è¯·åšå¥½å‡†å¤‡';
};

const formatTime = (seconds) => {
  const m = Math.floor(seconds / 60);
  const s = seconds % 60;
  return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
};

const mockCount = () => {
  count.value++;
  isStandard.value = true;
  statusText.value = 'åŠ¨ä½œæ ‡å‡†';
  setTimeout(() => {
    isStandard.value = false;
    statusText.value = 'ä¿æŒåŠ¨ä½œ';
  }, 1000);
};

const startTest = () => {
  if (isTesting.value) return;
  
  // #ifdef APP-PLUS
  if (cameraContext.value) {
      cameraContext.value.startRecord({
          success: () => console.log('Start record success'),
          fail: (e) => {
              console.error('Start record fail', e);
          }
      });
  }
  // #endif
  
  isTesting.value = true;
  count.value = 0;
  duration.value = 0;
  statusText.value = 'æ­£åœ¨è¯†åˆ«...';
  pendingVideoUrl.value = '';
  
  timer.value = setInterval(() => {
    duration.value++;
  }, 1000);
  
  captureTimer.value = setInterval(() => {
    mockCount();
  }, 3000);
};

const endTest = async () => {
  if (!isTesting.value) return;
  
  clearInterval(timer.value);
  clearInterval(captureTimer.value);
  isTesting.value = false;
  statusText.value = 'æµ‹è¯•ç»“æŸ';
  
  lastResult.value = {
    count: count.value,
    duration: formatTime(duration.value),
    date: new Date().toLocaleString()
  };
  
  uni.showLoading({ title: 'æ­£åœ¨å¤„ç†è§†é¢‘...' });
  
  // #ifdef APP-PLUS
  if (cameraContext.value) {
      cameraContext.value.stopRecord({
          success: async (res) => {
              const videoPath = res.tempVideoPath;
              try {
                  uni.showLoading({ title: 'æ­£åœ¨ä¸Šä¼ è§†é¢‘...' });
                  const uploadRes = await uploadFile(videoPath);
                  let evidenceUrl = '';
                  if (uploadRes && uploadRes.url) {
                      evidenceUrl = uploadRes.url;
                  }
                  await submitResult(evidenceUrl);
                  uni.hideLoading();
                  showCompletionModal();
              } catch (e) {
                  uni.hideLoading();
                  uni.showToast({ title: 'è§†é¢‘ä¸Šä¼ å¤±è´¥', icon: 'none' });
              }
          },
          fail: (e) => {
              console.error('Stop record fail', e);
              fallbackToSnapshot();
          }
      });
      return; 
  }
  // #endif

  fallbackToSnapshot();
};

const fallbackToSnapshot = async () => {
    try {
        const snapshotPath = await takeSnapshot();
        let evidenceUrl = '';
        if (snapshotPath) {
            const uploadRes = await uploadFile(snapshotPath);
            if (uploadRes && uploadRes.url) {
                evidenceUrl = uploadRes.url;
            }
        }
        await submitResult(evidenceUrl);
        uni.hideLoading();
        showCompletionModal();
    } catch (e) {
        uni.hideLoading();
        uni.showToast({ title: 'æ•°æ®æäº¤å¤±è´¥', icon: 'none' });
        console.error(e);
    }
};

const showCompletionModal = () => {
    uni.showModal({
      title: 'æµ‹è¯•å®Œæˆ',
      content: `é¡¹ç›®ï¼š${projectName.value}\næœ¬æ¬¡æˆç»©ï¼š${count.value}æ¬¡\nç”¨æ—¶ï¼š${formatTime(duration.value)}`,
      showCancel: false
    });
};

const takeSnapshot = () => {
  return new Promise((resolve, reject) => {
    // #ifndef H5
    if (cameraContext.value && cameraContext.value.takePhoto) {
      cameraContext.value.takePhoto({
        quality: 'normal',
        success: (res) => {
          resolve(res.tempImagePath);
        },
        fail: (err) => {
          console.error('App snapshot failed', err);
          resolve(null);
        }
      });
    } else {
      resolve(null);
    }
    // #endif
    // #ifdef H5
    resolve(null);
    // #endif
  });
};

const uploadFile = (filePath) => {
  return new Promise((resolve, reject) => {
    const token = uni.getStorageSync('token');
    uni.uploadFile({
      url: `${BASE_URL}/upload`,
      filePath: filePath,
      name: 'file',
      header: {
        'Authorization': `Bearer ${token}`
      },
      success: (uploadFileRes) => {
        try {
          const data = JSON.parse(uploadFileRes.data);
          resolve(data);
        } catch (e) {
          reject(e);
        }
      },
      fail: (err) => {
        reject(err);
      }
    });
  });
};

const submitResult = (evidenceUrlArg) => {
  return request({
    url: '/activity/finish',
    method: 'POST',
    data: {
      type: 'test',
      source: 'free',
      started_at: new Date(Date.now() - duration.value * 1000).toISOString(),
      ended_at: new Date().toISOString(),
      metrics: {
        count: count.value,
        duration: duration.value,
        qualified: count.value >= 10,
        checkpoints: JSON.stringify([])
      },
      evidence: [
        ...(evidenceUrlArg ? [{ evidence_type: 'video', data_ref: evidenceUrlArg }] : [])
      ]
    }
  });
};

const handleOptions = (options) => {
  if (options.project) projectName.value = options.project;
  if (options.type) testType.value = options.type;
  
  const standards = {
    'å¼•ä½“å‘ä¸Š': 'ä¸‹é¢Œè¿‡æ ï¼ŒåŒè‡‚ä¼¸ç›´',
    'ä»°å§èµ·å': 'åŒæ‰‹æŠ±å¤´ï¼Œè‚˜éƒ¨è§¦è†',
    'ä¿¯å§æ’‘': 'èº«ä½“å¹³ç›´ï¼Œå±ˆè‡‚90åº¦'
  };
  
  if (standards[projectName.value]) {
    standardDesc.value = standards[projectName.value];
  }
};

onLoad((options) => {
  const sys = uni.getSystemInfoSync();
  statusBarHeight.value = sys.statusBarHeight || 20;
  if (options) {
    handleOptions(options);
  }
});

const gotoStudents = () => {
  uni.navigateTo({ url: '/pages/teacher/students/students' });
};

const toggleCamera = () => {
  cameraPosition.value = cameraPosition.value === 'back' ? 'front' : 'back';
};

const retryCamera = () => {
  showCamera.value = false;
  setTimeout(() => {
    showCamera.value = true;
  }, 100);
};

const openSysSettings = () => {
    // #ifdef APP-PLUS
    uni.openAppAuthorizeSetting();
    // #endif
    // #ifndef APP-PLUS
    uni.openSetting();
    // #endif
};

const handleCameraError = (e) => {
  console.error('Camera Error:', e);
  showCamera.value = false;
  uni.showModal({
      title: 'æ‘„åƒå¤´æƒé™å—é™',
      content: 'è¯·åœ¨è®¾ç½®ä¸­å¼€å¯æ‘„åƒå¤´æƒé™ä»¥è¿›è¡Œæ‹æ‘„',
      confirmText: 'å»è®¾ç½®',
      success: (res) => {
          if (res.confirm) openSysSettings();
      }
  });
};
</script>

<style scoped>
.test-page-root {
  flex: 1;
  background-color: #1a1a1a;
  flex-direction: column;
}

.custom-navbar {
  position: fixed;
  top: 0;
  left: 0;
  width: 750rpx;
  background-color: #1a1a1a;
  /* z-index not needed if order is correct, but useful for fixed */
}

.navbar-content {
  height: 44px;
  flex-direction: row;
  align-items: center;
  justify-content: center;
}

.navbar-title {
  color: #fff;
  font-size: 16px;
  font-weight: bold;
}

.content-wrapper {
  flex: 1;
  flex-direction: column;
  align-items: center;
  width: 750rpx;
  padding-bottom: 20rpx;
}

.teacher-tools {
  width: 750rpx;
  padding: 40rpx 30rpx;
}

.teacher-card {
  background-color: #fff;
  border-radius: 12rpx;
  padding: 20rpx;
}

.teacher-title {
  font-size: 34rpx;
  font-weight: bold;
  margin-bottom: 10rpx;
  color: #333;
}

.teacher-actions {
  flex-direction: row;
}

.teacher-btn {
  background-color: #20C997;
  padding: 10rpx 20rpx;
  border-radius: 8rpx;
}

.teacher-btn-text {
  color: #fff;
  font-size: 28rpx;
}

.student-container {
  flex-direction: column;
  width: 750rpx;
  align-items: center;
}

.header-info {
  padding: 40rpx 30rpx 20rpx;
  align-items: center;
}

.project-name {
  font-size: 36rpx;
  font-weight: bold;
  margin-bottom: 10rpx;
  color: #fff;
}

.standard-badge {
  background-color: rgba(32, 201, 151, 0.2);
  padding: 8rpx 20rpx;
  border-radius: 12rpx;
  margin-bottom: 16rpx;
}

.badge-text {
  color: #20C997;
  font-size: 24rpx;
  font-weight: bold;
}

.standard-desc {
  font-size: 28rpx;
  color: #aaa;
  margin-top: 10rpx;
}

.test-type-switch {
  margin-top: 20rpx;
  flex-direction: column;
  align-items: center;
}

.switch-btn {
  background-color: rgba(255,255,255,0.1);
  padding: 12rpx 36rpx;
  border-radius: 30rpx;
  border-width: 1px;
  border-style: solid;
  border-color: rgba(32, 201, 151, 0.3);
}

.switch-btn-text {
  color: #20C997;
  font-size: 28rpx;
}

.type-selector {
  background-color: rgba(0,0,0,0.4);
  border-width: 1px;
  border-style: solid;
  border-color: rgba(255,255,255,0.1);
  border-radius: 16rpx;
  margin-top: 10rpx;
}

.type-item {
  padding: 16rpx 40rpx;
  border-bottom-width: 1px;
  border-bottom-style: solid;
  border-bottom-color: rgba(255,255,255,0.08);
}

.type-item-text {
  color: #fff;
  font-size: 28rpx;
  text-align: center;
}

.camera-area {
  width: 750rpx;
  height: 562.5rpx; /* 4:3 Aspect Ratio */
  background-color: #000;
  position: relative;
  justify-content: center;
  align-items: center;
  border-top-width: 1px;
  border-top-style: solid;
  border-top-color: #333;
  border-bottom-width: 1px;
  border-bottom-style: solid;
  border-bottom-color: #333;
}

.real-camera {
  width: 750rpx;
  height: 562.5rpx;
}

.camera-error-view {
  width: 750rpx;
  height: 562.5rpx;
  background-color: #222;
  justify-content: center;
  align-items: center;
}

.error-text {
  color: #ff6b6b;
  font-size: 30rpx;
  margin-bottom: 20rpx;
}

.retry-btn {
  background-color: #333;
  padding: 10rpx 30rpx;
  border-radius: 8rpx;
  border-width: 1px;
  border-style: solid;
  border-color: #444;
}

.retry-text {
  color: #fff;
  font-size: 28rpx;
}

.camera-overlay-content {
  position: absolute;
  top: 0;
  left: 0;
  width: 750rpx;
  height: 562.5rpx;
}

.count-overlay {
  position: absolute;
  top: 200rpx;
  left: 375rpx;
  /* translate not fully supported in styles, use layout */
  transform: translateX(-50%); 
  flex-direction: row;
  align-items: flex-end;
  justify-content: center;
}

.count-val {
  font-size: 100rpx;
  font-weight: 800;
  color: #20C997;
  line-height: 100rpx;
}

.count-label {
  font-size: 30rpx;
  color: rgba(255,255,255,0.8);
  margin-left: 12rpx;
  font-weight: bold;
  margin-bottom: 10rpx;
}

.progress-bar-container {
  position: absolute;
  bottom: 0;
  left: 0;
  width: 750rpx;
  height: 10rpx;
  background-color: rgba(255,255,255,0.1);
}

.progress-fill {
  height: 10rpx;
  background-color: #20C997;
}

.status-tips {
  position: absolute;
  bottom: 60rpx;
  left: 0;
  width: 750rpx;
  flex-direction: row;
  justify-content: center;
}

.status-text {
  background-color: rgba(0,0,0,0.7);
  padding: 16rpx 48rpx;
  border-radius: 50rpx;
  font-size: 32rpx;
  color: #fff;
  border-width: 1px;
  border-style: solid;
  border-color: rgba(255,255,255,0.1);
}

.valid-text {
  color: #20C997;
  background-color: rgba(32, 201, 151, 0.15);
  border-color: rgba(32, 201, 151, 0.4);
}

.action-area {
  width: 750rpx;
  padding: 20rpx 40rpx 60rpx;
  align-items: center;
}

.timer-box {
  margin-bottom: 40rpx;
  background-color: rgba(255,255,255,0.05);
  padding: 16rpx 40rpx;
  border-radius: 20rpx;
  align-items: center;
  border-width: 1px;
  border-style: solid;
  border-color: rgba(255,255,255,0.05);
}

.timer-label {
  font-size: 24rpx;
  color: #888;
  margin-bottom: 4rpx;
}

.timer-text {
  font-size: 60rpx;
  font-weight: bold;
  color: #fff;
}

.last-result-box {
  margin-top: 20px;
  background-color: #2a2a2a;
  border-radius: 12px;
  padding: 15px;
  width: 600rpx;
  border-width: 1px;
  border-style: solid;
  border-color: #333;
}

.result-title {
  color: #fff;
  font-size: 32rpx;
  font-weight: bold;
  margin-bottom: 20rpx;
  text-align: center;
}

.result-row {
  flex-direction: row;
  justify-content: space-between;
  margin-bottom: 10rpx;
}

.result-label {
  color: #888;
  font-size: 28rpx;
}

.result-value {
  color: #20C997;
  font-size: 32rpx;
  font-weight: bold;
}

.btn-group {
  flex-direction: row;
  width: 600rpx;
  justify-content: center;
}

.testing-btns {
  flex-direction: row;
  flex: 1;
  justify-content: space-between;
}

.main-btn {
  flex: 1;
  background-image: linear-gradient(to bottom right, #20C997, #17a077);
  height: 110rpx;
  align-items: center;
  justify-content: center;
  border-radius: 60rpx;
}

.sub-btn {
  flex: 1;
  height: 110rpx;
  align-items: center;
  justify-content: center;
  border-radius: 60rpx;
  margin: 0 10rpx;
}

.stop-btn {
  background-image: linear-gradient(to bottom right, #ff6b6b, #ee5253);
}

.mock-btn {
  background-color: rgba(255,255,255,0.1);
  border-width: 1px;
  border-style: solid;
  border-color: rgba(255,255,255,0.1);
}

.btn-text {
  color: #fff;
  font-size: 36rpx;
  font-weight: bold;
}

.mock-text {
  color: #ccc;
  font-size: 32rpx;
}

/* Modal styles */
.guide-modal {
  position: fixed;
  top: 0;
  left: 0;
  bottom: 0;
  right: 0;
  background-color: rgba(0,0,0,0.8);
  justify-content: center;
  align-items: center;
}

.guide-content {
  background-color: #fff;
  width: 600rpx;
  border-radius: 20rpx;
  padding: 40rpx;
  align-items: center;
}

.guide-title {
  font-size: 36rpx;
  font-weight: bold;
  margin-bottom: 30rpx;
  color: #333;
}

.guide-visual {
  width: 200rpx;
  height: 200rpx;
  background-color: #f5f5f5;
  border-radius: 20rpx;
  align-items: center;
  justify-content: center;
  margin-bottom: 30rpx;
}

.guide-emoji {
  font-size: 80rpx;
}

.guide-desc {
  font-size: 28rpx;
  color: #666;
  text-align: center;
  margin-bottom: 40rpx;
}

.guide-btn {
  background-color: #20C997;
  padding: 10rpx 60rpx;
  border-radius: 40rpx;
}

.guide-btn-text {
  color: #fff;
  font-size: 30rpx;
}

.h5-camera-wrapper {
  width: 750rpx;
  height: 562.5rpx;
  justify-content: center;
  align-items: center;
  background-color: #333;
}
</style>